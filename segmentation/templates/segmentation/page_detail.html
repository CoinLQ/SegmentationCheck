<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/static/favicon.ico">

    <title></title>

    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="/static/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/static/css/starter-template.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="/static/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="/static/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" media="screen" href="/static/css/svg.select.css">
    <style>
        .highlight {
          stroke: red;
          stroke-width: 4;
        }
        .segment-line {
          stroke: blue;
          stroke-width: 4;
        }
        .error-char {
          stroke: #FF00FF;
          stroke-width: 4;
        }
    </style>
</head>
<body>
  <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/segmentation">Home</a></li>
            <li><a href="/segmentation/K0001V01P0034a/">切分调整示例</a></li>
            <li><a href="/segmentation/charactercheck/%E5%A4%9A">切分校对</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <div>
          <div id="segmentation_page"></div>
          <button class="btn btn-default" id="save_button">保存</button>
      </div>

    </div><!-- /.container -->

<script src="/static/js/jquery-2.2.4.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/ie10-viewport-bug-workaround.js"></script>
<script src="/static/js/svg.min.js"></script>
<script src="/static/js/svg.draggable.min.js"></script>
<script type="text/javascript">
{% if page.width %}
var draw = new SVG('segmentation_page').size('{{ page.width }}', '{{ page.height }}');
{% else %}
var draw = new SVG('segmentation_page').size('1200', '800');
{% endif %}
draw.style('background:url(/page_images/{{ page.id }}.jpg) no-repeat;');

var lines = [];
var moves = {};
var line1 = null;
{% for char_line in line_lst %}
{% if char_line.line_no == 1 %}
line1 = draw.line({{ char_line.right }}, 0, {{ char_line.right }}, 837).addClass('segment-line');
line1.draggable().on('dragmove', function(e){
  e.preventDefault();
  this.x(e.detail.p.x);
}).on('dragend', function(e){
  console.log('line-0: ' + this.x() + ', ' + this.y());
  this.addClass('highlight').removeClass('segment-line');
  moves['line-0'] = this.x();
});
{% endif %}
line1 = draw.line({{ char_line.left }}, 0, {{ char_line.left }}, 837).addClass('segment-line');
line1.draggable().on('dragmove', function(e){
  e.preventDefault();
  this.x(e.detail.p.x);
}).on('dragend', function(e){
  var key = 'line-' + {{ char_line.line_no }};
  console.log(key + ': ' + this.x() + ', ' + this.y());
  this.addClass('highlight').removeClass('segment-line');
  moves[key] = this.x();
});
{% for character in char_line.char_lst %}

{% if character.char_no == 1 %}
line1 = draw.line({{ char_line.left }}, {{ character.top }}, {{ char_line.right }}, {{ character.top }}).addClass('segment-line');
line1.draggable().on('dragmove', function(e){
  e.preventDefault();
  this.y(e.detail.p.y);
}).on('dragend', function(e){
  var key = 'char-' + {{ char_line.line_no }} + '-0';
  console.log(key + ': y=' + this.y());
  this.addClass('highlight').removeClass('segment-line');
  moves[key] = this.y();
});
{% endif %}
line1 = draw.line({{ char_line.left }}, {{ character.bottom }}, {{ char_line.right }}, {{ character.bottom }}).addClass('segment-line');
{% if character.is_correct == -1 %}
line1.addClass('error-char').removeClass('segment-line');
{% endif %}
line1.draggable().on('dragmove', function(e){
  e.preventDefault();
  this.y(e.detail.p.y);
}).on('dragend', function(e){
  var key = 'char-' + {{ char_line.line_no }} + '-' + {{ character.char_no }};
  console.log(key + ': y=' + this.y());
  this.addClass('highlight').removeClass('segment-line');
  moves[key] = this.y();
});

{% endfor %}
{% endfor %}

$('#save_button').on('click', function(){
  moves['csrfmiddlewaretoken'] = '{{ csrf_token }}';
  $.post('/segmentation/{{ page.id }}/modify', moves,
  function(d) {
    console.log('ok');
    location.reload();
  });
});
</script>
</body>
</html>
