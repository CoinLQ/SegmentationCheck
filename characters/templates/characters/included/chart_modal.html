<style>

.bar {
  fill: teal;
}

.bar:hover {
  fill: brown;
}


/*.chart rect {
    fill: steelblue;
}*/

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
  font-size: 10px;
}

.chart .current {
  fill: green;
  cursor: pointer;
}
.modal { overflow: visible; }
.modal-body { overflow-y: visible; }
</style>
<div class="bd-classifyChart">
  <div class="modal fade" id="classifyChartModal" tabindex="-1" role="dialog" aria-labelledby="classifyChartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">

          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <div class="row">
          <div class="col-md-4"
            <div class="h4 modal-title" style="display: inline" id="classifyChartModalLabel"><strong id='chart_char' style='font-size:36px; margin:0px;padding:8px;color:#483D8B;'>？</strong>
            </div>
          <div class="col-md-5">
            <div id="classify-grade" class="dropdown" style="display: inline;margin-left: 30px">精度：
            <button id='l-btn' class="btn btn-default grade-btn" data-value=50>低</button>
            <button id='m-btn' class="btn btn-default grade-btn" data-value=20>中</button>
            <button id='h-btn' class="btn btn-default grade-btn active" data-value=5>高</button>
            </div>
          </div>
          </div>
        </div>
        <div class="modal-body">
          <div class="chart-container" style="margin-left:100px;margin-right: 10px;">
            <svg class="chart" width="670" height="200">
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/static/js/jquery-2.2.4.min.js"></script>
<script src="/static/StackedAreaChart/js/d3.min.js"></script>

<script>
function getSum(total, num) {
    if (total)
    {
      total.count += num.count;
    }
    total = total || num;

    return total;
}

var data =[];
var chunk = 50;
var current_char;

function loadSvg() {
  d3.json('/api/datapoint?char='+current_char,function(res){
      data =[];
      var i,j,temparray;
      for (i=0,j=res.length; i<j; i+=chunk) {
          temparray = res.slice(i,i+chunk);
          data.push(temparray.reduce(getSum));
          // do whatever
      }


    data.map(function(d) { d.range_idx = d.range_idx/1000;return d });
    new_data = []
    data.forEach(function (element, index, array) {
      if (index == 0)
      {
        new_data.push({ range_idx: data[index].range_idx, count: data[index].count + data[index+1].count/2 });
      }else if (index < data.length-2){
        new_data.push({ range_idx: data[index].range_idx, count: data[index].count/2 + data[index+1].count/2 })
      }else if (index == data.length-2) {
        new_data.push({ range_idx: data[index].range_idx, count: data[index].count/2 + data[index+1].count })
      }

    })
    data = new_data
    data.push({range_idx: 1, count:0});

    $.getScript("/static/js/charts_app.js");
  });
}

function markActive(){
  $(".grade-btn").removeClass("active");
  var btn;
  if (chunk == 50) {
    btn = $("#l-btn")
  } else if (chunk == 20) {
    btn = $("#m-btn")
  } else if (chunk == 5) {
    btn = $("#h-btn")
  }
  btn.addClass('active');
}
$(function(){
  $('#classifyChartModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget) // Button that triggered the modal
    var recipient = current_char = button.data('char'); // Extract info from data-* attributes
    // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
    // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
    var modal = $(this)
    modal.find('.modal-title').text('');
    modal.find('#chart_char').text(recipient);
    markActive();
    d3.selectAll("svg > *").remove();
    loadSvg();
  });

  $(".grade-btn").click(function() {
        var btn = $(this);
        chunk=btn.data('value');
        markActive();
        d3.selectAll("svg > *").remove();
        loadSvg();
    })
});


</script>