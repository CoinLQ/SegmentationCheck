{% extends "base.html" %}
{% block head %}
<title>字形列表</title>

<link href="/static/css/simplePagination.css" rel="stylesheet">
<link href="/static/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
<link rel="stylesheet" href="/static/treemap/css/font-awesome.min.css">
<link href="/static/css/csshake.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link rel="stylesheet" href="/static/datatables/dataTables.bootstrap.css">
<link rel="stylesheet" href="/static/characters/css/app.css">
<link rel="stylesheet" href="/static/characters/css/circle.css">
{% endblock %}
{% block mainbody %}
<div class="container" style="min-width:1000px !important;">
    <div class='row show-grid'>
        <div class='col-md-4 col-xs-12' >
            <div class="box">
                <div class="box-header">
                  <h3 class="box-title">&nbsp;</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                  <table id="char_index" class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th>No</th>
                        <th>字<br>形</th>
                        <th>总<br>数</th>
                        <th>正<br>样本</th>
                        <th>负<br>样本</th>
                        <th>未<br>标记</th>
                        <th>区<br>分度</th>
                    </tr>
                    </thead>
                    <tbody id="char_index_tbody">

                    </tbody>
                  </table>
                </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div><!--end col-md-3 -->

        <div class='col-md-8 col-xs-12' style="margin-top:75px;">
            <div class='row'>
                <div class="col-md-6" style="margin-top:-16px;">
                <strong id='checkchar' style='font-size:36px; margin:0px;padding:8px;color:#483D8B;'>？</strong>
                <a class="btn btn-default" href="javascript:;" onclick="checkDict()" style="margin-top:-12px;padding:8px 12px;"><span class="tooltip_text">查字典</span><span class="fa fa-book"></span></a>
                <a class="btn btn-default classifyChart hidden" href="javascript:;" data-toggle="modal" data-target="#classifyChartModal" data-char="？" style="margin-top:-12px;padding:8px 10px;"><span class="tooltip_text">相似度分布</span><span class="fa fa-bar-chart"></span></a>

                <a class="btn btn-default circle-btn accuracy_cal hidden" href="javascript:;" data-toggle="modal" data-target="#accuracyModal" data-char="？"><span class="tooltip_text">重算</span><span class="fa fa-calculator"></span>                
                <div class="radial-progress" data-progress="100">
                    <div class="circle">
                        <div class="mask full">
                            <div class="fill"></div>
                        </div>
                        <div class="mask half">
                            <div class="fill"></div>
                            <div class="fill fix"></div>
                        </div>
                        <div class="shadow1"></div>
                    </div>
                    <div class="inset1"></div>
                </div></a>

                <a class="btn btn-default accuracy_cal hidden" href="javascript:;" data-toggle="modal" data-target="#markModal" data-char="？" style="margin-top:-12px;padding:8px 12px;"><span class="tooltip_text">标记</span><span class="fa fa-paw"></span></a>

                </div>
                <div id="accuracy_scope" class="form-inline dropdown" style="display: inline-block;margin-left: 2px;float:right">
                  <label>相似度:<input class="accuracy_input form-control-inline" placeholder="0.5" aria-controls="char_index" style="margin-top:2px;"/></label>
                  <label style="margin-left:6px;">±

                  <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" style="margin-top: -5px"><span>0.01</span>
                  <span class="caret"></span></button>

                  <ul class="dropdown-menu" style="margin-left:45%">
                    <li><a data-value="0" href="#">0.000</a></li>
                    <li><a data-value="1" href="#">0.001</a></li>
                    <li><a data-value="2" href="#">0.002</a></li>
                    <li><a data-value="5" href="#">0.005</a></li>
                    <li><a data-value="10" href="#">0.01</a></li>
                    <li><a data-value="20" href="#">0.02</a></li>
                    <li><a data-value="50" href="#">0.05</a></li>
                    <li><a data-value="100" href="#">0.1</a></li>
                  </ul>
                  </label>
                </div>
                <div id="find_scope" class="dropdown" style="display: inline-block;float:right;margin: 0px 10px;">
                  <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown"><span>显示全部&nbsp;</span>
                  <span class="caret"></span></button>
                  <ul class="dropdown-menu" style="margin-top:8px;">
                    <li><a data-value="-10" href="#">显示全部</a></li>
                    <li><a data-value="0" href="#">未标记</a></li>
                    <li><a data-value="-1" href="#">人工标错</a></li>
                    <li><a data-value="1" href="#">人工标对</a></li>
                  </ul>
                </div>
                {% include "characters/included/audio_play.html" %}
            </div>

            <div style="clear:both;"> </div>
            <div id='charBrowseArea' style="margin-right:-15px;margin-left:18px;">
            </div>
            <div style="clear:both;"> </div>
            <div class="row" style="margin-top:10px;margin-left: 0px">
                <div  class="btn btn-default batch-check" id="correct_btn" ><span class="tooltiptext">剩余全部标对</span><span style="color: #9AFF9A;font-size:20px;padding:0px 8px" class="fa fa-check"></span><span style="color: #9AFF9A;font-size:20px;padding:0px 8px" class="fa fa-check"></span></div>
                <div  class="btn btn-default batch-check" id="err_btn"><span class="tooltiptext">剩余全部标错</span><span style="color: pink;font-size:20px;padding:0px 10px" class="fa fa-times"></span><span style="color: pink;font-size:20px;padding:0px 10px" class="fa fa-times"></span></div>
                <div class='char-pagitor'>
                    <span class='pagitor first btn btn-default' id='char_index_first'><span class="fa fa-step-backward"></span></span>
                    <span class='pagitor more-padding previous btn btn-default' id='char_index_previous' style="font-size:20px;">❮</span>
                    <input class='form-control-inline pagitor_input input-sm' type='number' min="1">
                    <span class='pagitor_of total_page'> </span>
                    <span class='pagitor more-padding next btn btn-default' id='char_index_next' style="font-size:20px;">❯</span>
                    <span class='pagitor last btn btn-default' id='char_index_last'><span class="fa fa-step-forward"></span></span>

                    <div id="LineControler" class="btn-group" style="padding:0px; margin-left: 10px;">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="margin-top:3px">
                        <span>100&nbsp;</span><span class="caret"></span> </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                        <li><a href="javascript:;">10&nbsp;</a></li>
                        <li><a href="javascript:;">20&nbsp;</a></li>
                        <li><a href="javascript:;">50&nbsp;</a></li>
                        <li><a href="javascript:;">100&nbsp;</a></li>
                        <li><a href="javascript:;">200&nbsp;</a></li>
                        <li><a href="javascript:;">500&nbsp;</a></li>
                        <li><a href="javascript:;">1000&nbsp; </a></li>
                        <li><a href="javascript:;">2000&nbsp; </a></li>
                    </ul>
                    <label style="line-height: 31px;">字/页</label>
                </div>
                </div>

                <div  class="btn btn-default batch-check" id="clear_btn"><span class="tooltiptext">全部清空标记</span><span style="font-size:16px" class="fa fa-repeat">&nbsp;&nbsp;清空</span></div>
                </div>
            <div style="clear:both;"> </div>

            <div class="pagec" id="pagearea">
                <ul class="pagination">
                </ul>
            </div>
        </div><!--end col-md-9 -->
    </div><!--endrow-->
    {% include "characters/included/chart_modal.html" %}
    {% include "characters/included/accuracy_modal.html" %}
    {% include "characters/included/mark_modal.html" %}
    <div class="loading_icon"><!-- Place at bottom of page --></div>
</div><!-- /.container -->
{% endblock %}

{% block foot  %}
<!-- DataTables -->
<script src="/static/datatables/jquery.dataTables.js"></script>
<script src="/static/datatables/dataTables.bootstrap.js"></script>
<script src="/static/datatables/input.js"></script>
<script type="text/javascript">
    var chars = [
    {% for char in characterstatistics_list %}
        [
            "{{forloop.counter}}",
            "{{char.char}}",
            "{{char.total_cnt}}",
            "{{char.correct_cnt}}",
            "{{char.err_cnt}}",
            "{{char.uncheck_cnt}}",
            "{{char.charstock.weight}}"
        ],
    {% endfor %}
    ]
</script>
<!-- page script -->
<script>
  $(function () {
    $("#char_index").DataTable({
      "pagingType": "input",
        "info":     false,
        "borderClasses": false,
        "bSortClasses": false,
        "bProcessing": true,
    "bDeferRender": true,
    "bProcessing": true,
    "bDeferRender": true,

    // Rows and column headers stored in a "data" object:
    "aaData": chars,
    language: {
        search:         "",
        lengthMenu:    " _MENU_ 字/页",
        loadingRecords: "载入数据中...",
        paginate: {
            first:      "<span class='fa fa-step-backward'></span>",
            previous:   "❮",
            next:       "❯",
            last:       "<span class='fa fa-step-forward'></span>"
        }
    }
    });
  });
</script>
<script src="/static/js/jquery.simplePagination.js" charset="utf-8"></script>
<script src="/static/js/jquery.cookie.js" charset="utf-8"></script>
<script >
var charListContainer =
    {
        char: '',
        page_size: 15,
        page_number: 1,
        filter: '-10',//show all
        accuracy_base: NaN,
        accuracy_scope: 10,
        data: [],
        total: 0,
        timers: [],
        pagination: {},
        paginationRender: function(){
            var total_pages = this.pagination.total_pages;
            $('.pagitor_input').val(this.page_number);
            $('.pagitor_input').attr('max',total_pages);
            $('.total_page').text('/ '+total_pages);
        },
        startWaitingAnimate: function(char, least){
          var t = new TimeLeft(char, least);
          this.timers = this.timers.filter(function(el) {
              return el.char != char;
          });
          this.timers.push(t);
          t.Start();
        },
        recallWaitingAnimate: function(){
          var that = this;
          t = this.timers.filter(function(el) {
              return el.char == that.char && el.Enable == true;
          });
          if (t[0]) t[0].showCircle();
        },
        hideWaitingAnimate: function(){
          var that = this;
          t = this.timers.filter(function(el) {
              return el.char == that.char;
          });
          if (t[0]) t[0].hideCircle();
        },
        hello: function(){
            alert('hello');
        },
        renderCharArea : function(){
            var area = "#charBrowseArea";
            var charArr = this.data;
            $(area).empty();
            txt =''
            $.each(charArr, function(i, field){
                txt = "<div id="+field.id+" class='flow "
                if (field.is_correct <0){
                    txt += "error-char o-error-char ";
                }
                else if (field.is_correct == 1){
                    txt += "correct-char o-correct-char ";
                } else {
                   txt += "twinkling ";
                }
                txt +="char-image' title='"+field.id+"'><img src='"+field.image_url +"' alt='加载中...' class='lazy'><span class='badge char-info'> "+ field.accuracy/1000+"</span> </div>"
                $(area).append(txt);
              });
        },
        binding_char_check : function (char){
            var selector = '#charBrowseArea .char-image'
            var _char = char;
            $(selector).click(function(){
                  var data = {'id': this.id};
                  play_bingo();
                  data['csrfmiddlewaretoken'] = '{{ csrf_token }}';
                  data['char'] = _char;
                  if ($(this).hasClass('error-char')) {
                    $(this).removeClass('error-char');
                    $(this).addClass('correct-char');
                    data['is_correct'] = 1;
                  } else {
                    $(this).removeClass('correct-char');
                    $(this).addClass('error-char');
                    data['is_correct'] = -1;
                  }
                $(this).removeClass("twinkling");
                $.post('/characters/set_correct', data);
            });
        },
        renderCharAndBind : function(){
            this.renderCharArea();
            this.binding_char_check(this.char);
        },
        switchAndRender: function() {
            var that = this;
            if (this.char == '') {
                return;
            }
            var query = "/api/character?page_size="+this.page_size
                +"&char="+this.char
                +"&page=1";//+this.page_number;
            var accuracy_cap, accuracy_floor;
            if (this.accuracy_base) {
                accuracy_cap = parseInt(this.accuracy_base*1000 + this.accuracy_scope);
                accuracy_floor = parseInt(this.accuracy_base*1000 - this.accuracy_scope);

                if (accuracy_cap <1 || this.accuracy_scope ==0) {
                    query += "&accuracy__lte="+accuracy_cap;
                }
                if (accuracy_floor>-1 || this.accuracy_scope ==0) {
                    query += "&accuracy__gte="+accuracy_floor;
                }

            }
            if(this.filter != -10){
                query += "&is_correct="+this.filter;
            }

            $.getJSON(query,function(result){
                that.data = result.models;
                var before_page_n = charListContainer.pagination.total_pages;
                that.pagination = result.pagination;
                page_n = $('.pagitor_input').val();
                var current_page = parseInt(page_n) || 0;
                var jump_page = Math.ceil((current_page/ before_page_n) * that.pagination.total_pages);
                if (current_page == 1) {
                    jump_page = 1;
                }
                charListContainer.page_number=jump_page;
                charListContainer.fetchDataAndRender();

            });
        },
        fetchDataAndRender: function(){
            var that = this;
            if (this.char == '') {
                return;
            }
            var query = "/api/character?page_size="+this.page_size
                +"&char="+this.char
                +"&page="+this.page_number;
            var accuracy_cap, accuracy_floor;
            if (this.accuracy_base) {
                accuracy_cap = parseInt(this.accuracy_base*1000 + this.accuracy_scope);
                accuracy_floor = parseInt(this.accuracy_base*1000 - this.accuracy_scope);

                if (accuracy_cap <1 || this.accuracy_scope ==0) {
                    query += "&accuracy__lte="+accuracy_cap;
                }
                if (accuracy_floor>-1 || this.accuracy_scope ==0) {
                    query += "&accuracy__gte="+accuracy_floor;
                }

            }
            if(this.filter != -10){
                query += "&is_correct="+this.filter;
            }

            $.getJSON(query,function(result){
                that.data = result.models;
                that.pagination = result.pagination;
                that.renderCharAndBind();
                that.paginationRender();
            });
        }
    }
//inital page_size
$(function(){
    var page_size = $.cookie('charindex_page_size');
    if(page_size== undefined){
        page_size = 50;
    }
    charListContainer.page_size = page_size;
});

function checkDict(){
    href="javascript:;"
    url = "http://hanzi.lqdzj.cn/hanzi-dict/search?param="
    url += charListContainer.char;
    var _open = window.open(url);
    if (_open == null || typeof(_open)=='undefined')
        console.log("Turn off your pop-up blocker!");
}
$('.accuracy_input').on('input',function(e){
    charListContainer.accuracy_base=parseFloat($(this).val());
});

//handler char select
$('#char_index #char_index_tbody').on('click', 'tr', function(event) {
    $('tr').removeClass("selected");
    $(this).addClass("selected");
    charListContainer.hideWaitingAnimate();
    charListContainer.char = $("tr.selected td:eq(1)").text();
    charListContainer.recallWaitingAnimate();
    charListContainer.total = parseInt($("tr.selected td:eq(2)").text());
    $("#checkchar").text(charListContainer.char);
    $(".classifyChart").data('char', charListContainer.char);
    $(".accuracy_cal").data('char', charListContainer.char);
    $(".classifyChart").removeClass('hidden');
    $(".accuracy_cal").removeClass('hidden');
    charListContainer.page_number=1;
    //charListContainer.filter="-10";
    $('.radio-btn').removeClass('actived');
    $('.radio-btn.show-all').addClass('actived');
    charListContainer.fetchDataAndRender();
})


//page_size selector
$(function() {
    var page_size = charListContainer.page_size;
    $("#LineControler button span:first-of-type").text(page_size);
    $('.accuracy_input').val('');

    $("#LineControler li a").click(function () {
        var page_size = $(this).text();
        charListContainer.page_size = page_size;
        $("#LineControler button span:first-of-type").text(page_size);
        $.cookie('charindex_page_size', page_size, { expires: 30 });
        charListContainer.page_number=1;
        charListContainer.fetchDataAndRender();
    })

    $("#find_scope .dropdown-menu a").click(function() {
        var li = $(this);
        li.parent().parent().parent().find("button span:first-of-type").text(li.text());
        charListContainer.filter=li.data('value');
        charListContainer.switchAndRender();
    })

    $("#accuracy_scope .dropdown-menu a").click(function() {
        var li = $(this);
        li.parent().parent().parent().find("button span:first-of-type").text(li.text());
        charListContainer.accuracy_scope=li.data('value');
        charListContainer.switchAndRender();
    })
})
// batch handle
$(function(){
    $('.batch-check').click(function(){
        var btn = $(this);
        var is_correct=-2;
        if (btn.attr('id')=='err_btn'){
            is_correct = -1;
        } else if (btn.attr('id')=='correct_btn') {
            is_correct = 1;
        } else {
            is_correct = 0;
        }
        handler(is_correct,btn);
    });
})
function handler(is_correct,btn) {
    var arr =[];
    var charlist = $("#charBrowseArea").children();
    for (var i=0;i<charlist.length;i++){
        var tmp = charlist[i];

        if (! ($(tmp).hasClass('error-char') || $(tmp).hasClass('correct-char') )){
            if(is_correct==-1){
                $(tmp).addClass('error-char');
            }
            else if (is_correct==1){
                $(tmp).addClass('correct-char');
            }
            arr.push(tmp.id);
        }
    }
    if (is_correct == 0)
    {
        arr = charlist.map(function() {return this.id}).get();
    }else {
        $(".char-image").removeClass("twinkling")
    }
    var data = {};
    var updateNum = arr.length;
    var e_num = $("#charBrowseArea .error-char").length;
    var c_num = $("#charBrowseArea .correct-char").length;
    data['csrfmiddlewaretoken'] = '{{ csrf_token }}';
    data['char'] = charListContainer.char;
    if ( is_correct == 1) {
        data['c_charArr'] = arr;
        data['c_updateNum'] = arr.length;
    } else if ( is_correct == -1) {
        data['e_charArr'] = arr;
        data['e_updateNum'] = arr.length;
    } else if ( is_correct == 0) {
        data['cl_charArr'] = arr;
        data['cl_updateNum'] = arr.length;
        data['e_num'] = e_num;
        data['c_num'] = c_num;
        $('.correct-char').map(function() {return $(this).removeClass('correct-char')});
        $('.error-char').map(function() {return $(this).removeClass('error-char')});
    }
    $.post('/characters/set_correct', data, function(res) {
       if(res['clear']=='ok'){
        $('.correct-char').map(function() {return $(this).removeClass('correct-char')});
        $('.error-char').map(function() {return $(this).removeClass('error-char')});
        $(".char-image").addClass("twinkling")
       }
    });
    play_batch_mark();
}

$(function(){
 $('.pagitor').click(function(){
        if($(this).hasClass('first')){
            page_number=1;
        }
        else if($(this).hasClass('previous')){
            page_number= charListContainer.pagination.previous_page;
        }
        else if($(this).hasClass('next')){
            page_number= charListContainer.pagination.next_page;
        }
        else if($(this).hasClass('last')){
            page_number= charListContainer.pagination.total_pages;
        }
        if (!page_number) {
            return;
        }
        charListContainer.page_number=page_number;
        charListContainer.fetchDataAndRender();
    });
})

$('input').keypress(function( event ){
    if(event.which == 13){
        var page_number = parseInt($('.pagitor_input').val()) || 1;
        charListContainer.page_number=page_number;
        charListContainer.fetchDataAndRender();
    }
});
</script>


<script src="/static/js/jquery.lazyload.min.js" charset="utf-8"></script>
<script src="/static/js/time_left.js" charset="utf-8"></script>
<script>
$body = $("body");
$(document).on({
    // ajaxStart: function() {
    //     $body.addClass("loading");
    // },
    // ajaxComplete: function() {
    //   $body.removeClass("loading");
    // }

//     ('head style[type="text/css"]').attr('type', 'text/less');
// less.refreshStyles()

});
$('.radial-progress').click(function(evt) {
  evt.stopPropagation();
    //$('.radial-progress').attr('data-progress', Math.floor(Math.random() * 100));
});
$("img.lazy").lazyload({
    effect : "fadeIn"
});

</script>

{% endblock %}













































