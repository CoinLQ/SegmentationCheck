{% extends "base.html" %}
{% block head %}
<title>字索引</title>

<link href="/static/css/simplePagination.css" rel="stylesheet">
<link href="/static/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link rel="stylesheet" href="/static/datatables/dataTables.bootstrap.css">
<link rel="stylesheet" href="/static/characters/css/app.css">
{% endblock %}
{% block mainbody %}
<div class="container" style="min-width:1000px !important;">
    <div class='row show-grid'>
        <div class='col-md-4 col-xs-4' >
            <div class="box">
                <div class="box-header">
                  <h3 class="box-title">字形列表</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                  <table id="char_index" class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th>No</th>
                        <th>字</th>
                        <th>字形总数</th>
                        <th>正样本</th>
                        <th>负样本</th>
                        <th>未标记</th>
                    </tr>
                    </thead>
                    <tbody id="char_index_tbody">
                  {% for char in characterstatistics_list%}
                  <tr>
                      <td>{{ forloop.counter }}</td>
                      <td>{{char.char}}</td>
                      <td>{{char.total_cnt}}</td>
                      <td>{{char.correct_cnt}}</td>
                      <td>{{char.err_cnt}}</td>
                      <td>{{char.uncheck_cnt}}</td>
                  </tr>
                  {% endfor %}
                    </tbody>
                  </table>
                </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div><!--end col-md-3 -->
        <div class='col-md-8 col-xs-8'>

            <div style="clear:both;"> </div>
            <div id='charBrowseArea'>
            </div>
            <div style="clear:both;"> </div>
            <div style="float:right; margin-right:64px;">
                <div  class="btn btn-primary batch-check" >批量標對</div>
                <div  class="btn btn-primary batch-check" id="err_btn">批量標錯</div>
            </div>
            <div style="clear:both;"> </div>
            <div class="pagec" id="pagearea">
                <ul class="pagination">
                </ul>
            </div>


            <div id="example">aaaa</div>


        </div><!--end col-md-9 -->
    </div><!--endrow-->
</div><!-- /.container -->
{% endblock %}
{% block foot  %}
<script src="/static/js/jquery.cookie.js" charset="utf-8"></script>
<!--react-->
<script src="//cdn.bootcss.com/redux/3.5.2/redux.min.js"></script>
<script src="//cdn.bootcss.com/react/15.3.2/react.js"></script>
<script src="//cdn.bootcss.com/react/15.3.2/react-dom.js"></script>
<script src="/static/js/browser.min.js"></script>
<!--<script src="/static/characters/js/char-area.js" type="text/babel"></script>-->
<script>
/** Action Creators */
function inc() {
  return {
    type: 'INCREMENT',
    data : 2,
  };
}
function dec() {
  return { type: 'DECREMENT' };
}

function reducer(state, action) {
  // 首次调用本函数时设置初始 state
  state = state || { counter: 0 };

  switch (action.type) {
    case 'INCREMENT':
      return { counter: state.counter + action.data };
    case 'DECREMENT':
      return { counter: state.counter - 1 };
    default:
      return state; // 无论如何都返回一个 state
  }
}

var store = Redux.createStore(reducer);

console.log( store.getState() ); // { counter: 0 }

store.dispatch(inc());
console.log( store.getState() ); // { counter: 1 }

store.dispatch(inc());
console.log( store.getState() ); // { counter: 2 }

store.dispatch(dec());
console.log( store.getState() ); // { counter: 1 }
</script>

<script  type="text/babel">
var PageSizeSelector = React.createClass({
    getInitialState: function(){
        var page_size = $.cookie('charindex_page_size');
        return {
            page_size_list: [50,100,200,300,900],
            page_size: page_size,
        };
    },
    handleSelect: function(item) {
        var that = this;
        $.cookie('charindex_page_size', item, { expires: 30 });
        return function (item) {
            that.setState({page_size: item})
            that.props.onPageSizeUpdate( item)
        };
    },
    render: function(){
         var PageSizeChoices = this.state.page_size_list.map(function(choice,i){
            return(
                <li onClick={this.handleSelect(choice).bind(this, choice)} key={i}><a>{choice}</a></li>
            );
        },this);
        return(
            <div>
                <div id="LineControler" className="btn-group" >
                    <button type="button" className="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span> {this.state.page_size} </span><span className="caret"></span> </button>
                    <ul className="dropdown-menu" aria-labelledby="dropdownMenu1">
                    {PageSizeChoices}
                    </ul>
                </div>
                <h1>{this.state.page_size}</h1>
             </div>
        );
    }
})

var CharNode = React.createClass({
    render : function(){
        return (
            <img src={this.props.src} id={this.props.id}></img>
        );
    }
})
var CharList = React.createClass({
 render : function(){
    var CharElements = this.props.data.map(function(char){
        return (
            <CharNode src={char.image_url} id={char.id} key={char.id}></CharNode>
        );
    })
    return (
        <div>
            {CharElements}
        </div>
    );
}
})

var CharArea = React.createClass({
    getInitialState: function(){
        return {
            data:[],
            page_size: 15,
            page:1,
        };
    },
    componentDidMount: function(){
        this.get_characters()
    },
    get_characters: function() {
        console.log('get_char');
         $.ajax({
          url: this.props.url+"&page_size="+this.state.page_size,
          dataType: 'json',
          cache: false,
          success: function(data) {
            this.setState({data: data.models});
          }.bind(this),
          error: function(xhr, status, err) {
            console.log('error');
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
    },
    handlePageSizeUpdate:function(page_size){
        this.setState({page_size:page_size});
        this.get_characters();
    },
    handleClick: function(event){
        this.setState({page_size:3});
        this.get_characters();
    },
    render: function(){
        return(
        <div>
            <CharList  data={this.state.data}/>
            <div className="btn btn-primary" onClick={this.handleClick}> click me</div>
            <PageSizeSelector onPageSizeUpdate={this.handlePageSizeUpdate}/>
        </div>
        );
    }
})

ReactDOM.render(
  <CharArea url='http://127.0.0.1:8000/api/character?format=json'/>,
  document.getElementById('example')
);
</script>
<!-- DataTables -->
<script src="/static/datatables/jquery.dataTables.min.js"></script>
<script src="/static/datatables/dataTables.bootstrap.min.js"></script>
<script src="/static/datatables/input.js"></script>
<!-- page script -->
<script>
  $(function () {
    $("#char_index").DataTable({
      "pagingType": "input",
        "info":     false
    });
  });
</script>
<script src="/static/js/jquery.simplePagination.js" charset="utf-8"></script>
<script >
var g_char;
var page_size = 30;
$('#char_index #char_index_tbody').on('click', 'tr', function(event) {
    $('tr').removeClass("selected");
    $(this).addClass("selected");
    g_char = $("tr.selected td:eq(1)").text();
    page_size = $.cookie('charindex_page_size');
    if ( page_size==null) {
        page_size = 30;
    }
    $.getJSON("/api/character?page_size="+page_size+"&char="+g_char,function(result){
        data = result.models;
        pagination = result.pagination;
        paginationFun(pagination.total_entries,page_size);
        renderCharArea("#charBrowseArea",data);
        binding_char_check('#charBrowseArea');
    });
})

function binding_char_check(area){
    var selector = area + ' .char-image'
        $(selector).click(function(){
          var data = {'id': this.id};
          data['csrfmiddlewaretoken'] = '{{ csrf_token }}';
          data['char'] =g_char;
          if ($(this).hasClass('error-char')) {
            $(this).removeClass('error-char');
            $(this).addClass('correct-char');
            data['is_correct'] = 1;
          } else {
            $(this).removeClass('correct-char');
            $(this).addClass('error-char');
            data['is_correct'] = -1;
          }
        $.post('/characters/set_correct', data);
    });
}

function renderCharArea(area,charArr){
    $(area).empty();
    txt =''
    $.each(charArr, function(i, field){
        txt = "<div id="+field.id+" class='flow "
        if (field.is_correct <0){
            txt += "error-char ";
        }
        else if (field.is_correct == 1){
            txt += "correct-char ";
        }
        txt +="char-image' title='"+field.id+"'><img src='"+field.image_url+"' alt='加载中'></div>"
        $(area).append(txt);
      });
}

function paginationFun(_items,_itemsOnpage){
    $('#pagearea').pagination({
        items: _items,
        itemsOnPage: _itemsOnpage,
        cssStyle: 'light-theme',
        onPageClick: function(pageNumber, event) {
                // Callback triggered when a page is clicked
                // Page number is given as an optional parameter
                var url = "/api/character?page_size="+page_size
                    +"&char="+g_char
                    +"&page="+pageNumber
                $.getJSON(url,function(result){
                    renderCharArea("#charBrowseArea",result.models);
                    binding_char_check('#charBrowseArea');
                });
            },
    });
}
</script>
<script>
$(function(){
    $('.batch-check').click(function(){
        var btn = $(this);
        var is_correct=1;
        if (this.id=='err_btn'){
            is_correct = -1;
        }
        handler(is_correct,btn);
    });
})
function handler(is_correct,btn) {
    var arr =[];
    var charlist = $("#charBrowseArea").children();
    for (var i=0;i<charlist.length;i++){
        var tmp = charlist[i];

        if (! ($(tmp).hasClass('error-char') || $(tmp).hasClass('correct-char') )){
            if(is_correct==-1){
                $(tmp).addClass('error-char');
            }
            else{
                $(tmp).addClass('correct-char');
            }
            arr.push(tmp.id);
        }
    }
    var data = {
        'charArr':arr,
        'is_correct':is_correct
        };
    var updateNum = arr.length;
    data['csrfmiddlewaretoken'] = '{{ csrf_token }}';
    data['char'] = g_char;
    data['updateNum'] = updateNum;
    $.post('/characters/set_correct', data, function() {
       if(data['status']=='ok'){
       }
    });
}
</script>
{% endblock %}
