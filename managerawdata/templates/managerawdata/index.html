{% extends "base.html" %}
{% block head %}
<title>原始数据管理</title>
<link href="/static/css/bootstrap-select.min.css" media="all" rel="stylesheet" type="text/css" />
<link href="/static/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
{% endblock %}
{% block mainbody %}
<div class="container">


          <select id='Tripitaka' class="selectpicker show-menu-arrow" data-live-search="true" >
            <option >====大藏经===</option>
            {% for tri in tripitaka_list%}
            <option value='{{tri.id}}'>{{ tri.name}}</option>
            {% endfor %}
          </select>


          <select id='Volume' class="selectpicker show-menu-arrow" data-live-search="true" >
          </select>
    <form enctype="multipart/form-data" class="hidden">
        <div class="form-group">
          <label for="page">起始页:</label>
          <input type="number" class="form-control" id="start_page">
        </div>
        <input id="imagefile" class="file" type="file" multiple >
    </form>
</div>

{% endblock %}
{% block foot  %}

<script src="/static/js/bootstrap-select.min.js"></script>

<!-- canvas-to-blob.min.js is only needed if you wish to resize images before upload.  This must be loaded before fileinput.min.js -->
<!-- script src="/static/js/plugins/canvas-to-blob.min.js" type="text/javascript"></script -->
<!-- sortable.min.js is only needed if you wish to sort / rearrange files in initial preview.  This must be loaded before fileinput.min.js -->
<!-- script src="/static/js/plugins/sortable.min.js" type="text/javascript"></script -->
<!-- purify.min.js is only needed if you wish to purify HTML content in your preview for HTML files.  This must be loaded before fileinput.min.js -->
<!--script src="/static/js/plugins/purify.min.js" type="text/javascript"></script -->
<!-- the main fileinput plugin file -->
<script src="/static/js/fileinput.min.js" type="text/javascript"></script>
<!-- optionally if you need a theme like font awesome theme you can include it as mentioned below -->
<!-- script src="/static/themes/fa/theme.js"></script -->
<!-- optionally if you need translation for your language then include locale file as mentioned below -->
<script src="/static/js/locales/zh.js" type="text/javascript"></script>


<script>
var volumes = [];

$('#imagefile').fileinput({
    language: 'zh',
    uploadUrl: 'opage/upload',
    //allowedFileExtensions : ['jpg', 'png','gif'],
    //uploadExtraData: {'tripitaka_id': 1, 'volume_id': 2, 'start_page': 3},
});



$('#Tripitaka').on('changed.bs.select', function (e) {
  var request = $.getJSON({
        type: 'GET',
        url: '/api/tripitaka/' + e.target.value + '/',
    });
  request.done(function(data){

        $("#Volume").empty();
        $("#Volume").append(
                $("<option></option>").attr(
                    "value", "").text("--- 册` ---")
            );
        volumes = data.volumes;
       for (var i = 0; i < data.volumes.length; i++) {
            $("#Volume").append(
                $("<option></option>").attr(
                    "value", i).text(volumes[i].number)
            );
        }
        $('#Volume').selectpicker('refresh');
    });
});

function setExtraData(){
    var tripitaka_id = $('#Tripitaka').find("option:selected").attr("value");
    var volume_idx = $('#Volume').find("option:selected").attr("value");
    var volume_id = volumes[volume_idx].id;
    var start_page = $('#start_page').val();
    $('#imagefile').fileinput('refresh', 
        {
            allowedFileExtensions : ['jpg', 'png','gif'],
            uploadExtraData: {
                'tripitaka_id': tripitaka_id, 
                'volume_id': volume_id, 
                'start_page': start_page,
            },
        }
    );
}

$('#Volume').on('changed.bs.select', function (e) {
    var volume_idx = $('#Volume').find("option:selected").attr("value");
    var start_page = parseInt(volumes[volume_idx].start_page);
    var end_page = parseInt(volumes[volume_idx].end_page);
    console.log(end_page);
    $("#start_page").val(start_page);
    $("#start_page").attr("min",start_page);
    $("#start_page").attr("max",end_page);
    $("form").removeClass("hidden");
    setExtraData();
});
</script>


{% endblock %}
